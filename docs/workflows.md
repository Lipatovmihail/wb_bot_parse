# Документация по воркфлоу WB API

Ниже кратко описаны этапы каждого из реализованных воркфлоу, чтобы было проще ориентироваться в логике бота.

## 01. Orders

- **Цель**: собрать актуальные заказы из WB и загрузить их в таблицу `WB_orders`, обновив статус селлеров.

### 1. Подготовка селлеров
- Берём всех селлеров с `in_workrnp = 1`.
- Парсим `orders_status`; создаём приоритеты:
  - `new` — без статуса, выгружаем сразу.
  - `left/right` — применяем логика кулдауна (30 минут для `right`), выбираем доступных.
- В Telegram уходит сводка с отметками, кто разрешён.

### 2. Сбор данных
- Для разрешённых селлеров последовательно вызываем:  
  `GET https://statistics-api.wildberries.ru/api/v1/supplier/orders`  
  Параметры: `dateFrom` (подобранный на первом этапе), хедеры `User-Agent`, `Authorization: Bearer <token>`.
- Ошибки логируем и отправляем в Telegram.

### 3. Формирование файла
- Преобразуем JSON к плоскому списку, пишем CSV `WB_orders_import.csv`.
- `LOAD DATA INFILE` -> `WB_orders`.

### 4. Статус
- Обновляем `orders_status` в `WB_sellers_updates`, фиксируем результат в Telegram.

## 02. Sales

- **Цель**: собрать продажи селлеров в `WB_sales`, обновить статус.

### 1. Подготовка селлеров
- Аналогично заказам: читаем `sales_status`, применяем кулдауны (`right` — 30 минут).
- В Telegram отправляем таблицу выбора.

### 2. Сбор данных
- `GET https://statistics-api.wildberries.ru/api/v1/supplier/sales`
- Параметры: `dateFrom` в query. Хедеры те же, что и в orders.

### 3. CSV и загрузка
- Конвертация -> `WB_sales_import.csv`.
- `LOAD DATA INFILE` в `WB_sales`.

### 4. Статус
- `update_sales_status` вычисляет новые параметры (включая границы дат, статус `right/left`).
- Отправляем итоги в Telegram.

## 03. Products

- **Цель**: выгрузить карточки товаров и обновить `products_status`.

### 1. Подготовка селлеров
- Читаем `products_status`. Новичков берём сразу, остальные — по кулдауну (60 минут).
- Если селлер в кулдауне, пишем в логи «Отложили…».
- Выборка публикуется в Telegram.

### 2. Сбор карточек
- `POST/GET https://content-api.wildberries.ru/content/v2/get/cards/list` (используем текущую реализованную функцию `fetch_products_for_seller` с пагинацией).
- Для каждой карточки собираем размеры, характеристики, фото.
- Ошибки Telegram-оповещением.

### 3. CSV и загрузка
- `WB_products_import.csv` с расширенными полями (`nmID`, `imtID`, `description`, `skus` и т.д.).
- `LOAD DATA INFILE` в `WB_products`.

### 4. Статус
- `update_products_status` считает:
  - количество уникальных `nmID`, `imtID`, `subjectName`, `brand`, `video`,
  - уникальные `skus`, `needKiz`, валидные габариты.
- Результат сохраняется в `products_status` (`WB_sellers_updates`) и отправляется в Telegram.

## 04. Ad List

- **Цель**: получить перечень рекламных кампаний, загрузить в `WB_ad_campaigns`, хранить краткий статус по селлеру.

### 1. Подготовка селлеров
- Читаем `ad_list_status`, учитываем кулдаун (`ADS_COOLDOWN_MINUTES`, по умолчанию 60 мин).
- Отсылаем сводку и информацию о селлерах, отправленных на ожидание.

### 2. Сбор данных
- `GET https://advert-api.wildberries.ru/adv/v1/promotion/count`
- WB отдаёт массив блоков `adverts`: каждый содержит `type`, `status`, `count`, `advert_list`.
- Мы суммируем `count`, отдельно считаем активные (`status == 9`) и на паузе (`status == 11`).
- Побочный эффект: формируем плоские строки с `advertId`, `changeTime` (нормализованный), `type`, `status`, `seller_id`.

### 3. CSV и загрузка
- `WB_ad_list_import.csv` -> `LOAD DATA INFILE` -> `WB_ad_campaigns`.
- Ошибки фиксируются и отправляются в Telegram.

### 4. Статус
- `update_ad_list_status` записывает JSON:
  ```json
  {
    "nowTime": "YYYY-MM-DD HH:MM:SS",
    "ad_all_cnt": <всего>,
    "ad_active_cnt": <status=9>,
    "ad_paused_cnt": <status=11>
  }
  ```
- Статус сохраняется в `WB_sellers_updates` и отправляется в Telegram сводкой `all/active/paused`.

## 05. Ad Stats

- **Цель**: собрать статистику по рекламным кампаниям (по дням и площадкам) и сохранить CSV для последующей загрузки.

### 1. Подготовка селлеров
- SQL-запрос берёт `ad_stats_status` и список кампаний (`WB_ad_campaigns`).
- Разрешены только кампании в статусах `7`, `9`, `11`.
- Кулдауны такие же, как в других блоках: `new` — сразу, `left` — минимальный `nowTime`, `right` — когда все в right.
- Telegram получает сводку с короткими датами и отметками допуска.

### 2. Планирование запросов
- Диапазон: максимум 180 дней, интервал — до 31 дня.
- Кампании режутся пачками по 100 ID (из-за ограничения API).
- Для каждого запроса рассчитывается `ready_at`: 3 запроса/минуту, пауза 20 сек. План сортируется по времени, чтобы селлеры не блокировали друг друга.
- В Telegram отправляется резюме (количество запросов, первые строки с брендами).

### 3. Выполнение запросов
- Запрос: `GET https://advert-api.wildberries.ru/adv/v3/fullstats` (`beginDate`, `endDate`, `ids`).
- Перед выполнением бот ждёт до планового `ready_at`.
- Результат фильтруется: пропускаем кампании без `days`, по каждой строке `nm` формируем агрегат (views, clicks, ctr, cr, sum и т.д.), плюс `avg_position` из `boosterStats`.
- Ошибки аккумулируются и отправляются отдельным сообщением.

### 4. CSV и отчёт
- Пишем `WB_ad_stats_import.csv` (без загрузки в БД).
- Telegram-сводка по итогам: сколько запросов выполнилось/пустых, сколько строк статистики по каждому бренду.

---

Чтобы добавить новый воркфлоу:
1. Определить таблицы и статус в `WB_sellers_updates`.
2. Скопировать структуру «подготовка → запрос → CSV → загрузка → статус».
3. Не забыть про Telegram-уведомления и кулдаун.***

